{% extends "layout.html" %}

{% load static %}
{% block title %} {{reserve.name}} {% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'reserves.css' %}" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- PhotoSwipe 5 -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/photoswipe@5/dist/photoswipe.css"
  />
{% endblock %}

{% block body %}
<main class="reserve-detail">
  <header class="reserve-detail__header">
    <h1 class="reserve-detail__title">{{ reserve.name }}</h1>
    <p class="reserve-detail__description">{{ reserve.description|linebreaks }}</p>
  </header>

  <section class="reserve-detail__birds">
    <h2 class="reserve-detail__subtitle">Aves que se pueden observar</h2>
    <ul class="reserve-detail__bird-list">
      {% for bird in birds %}
      <li class="reserve-detail__bird-item">
        <article class="bird-in-reserve">
          {% if bird.photo %}
            <img class="bird-in-reserve__image" src="{{ bird.photo.image.url }}" alt="Foto de {{ bird.common_name }}">
          {% else %}
            <img class="bird-in-reserve__image" src="{% static 'images/no_bird_photo.png' %}" alt="Sin foto disponible">
          {% endif %}
          <div class="bird-in-reserve__info">
            <a class="bird-in-reserve__name" href="{% url 'bird_detail' bird.slug %}">{{ bird.common_name }}</a>
            <span class="bird-in-reserve__scientific">{{ bird.scientific_name }}</span>
          </div>
        </article>
      </li>
      {% empty %}
      <li class="reserve-detail__bird-item">
        No se han registrado aves para esta reserva.
      </li>
      {% endfor %}
    </ul>
  </section>

  <section class="reserve-detail__photos">
    <h2 class="reserve-detail__subtitle">Fotos de la reserva</h2>
    <div id="photoswipe-gallery" class="reserve-detail__photo-grid">
      {% for photo in photos %}
      <a
        href="{{ photo.image.url }}"
        data-pswp-width="1024"
        data-pswp-height="768"
        class="reserve-detail__photo-item"
      >
        <img src="{{ photo.image.url }}" alt="{{ photo.description }}" />
        {% if photo.description %}
        <figcaption>{{ photo.description }}</figcaption>
        {% endif %}
      </a>
      {% empty %}
      <div class="reserve-detail__photo-item">
        <img src="{% static 'images/no_bird_photo.png' %}" alt="Sin foto disponible" />
        <figcaption>Sin descripción</figcaption>
      </div>
      {% endfor %}
    </div>
  </section>
  <section class="reserve-map">
    <h2 class="reserve-map__subtitle">Ubicación de la reserva</h2>
    <div id="reserve-map" style="height: 350px; border-radius: 12px; margin-bottom: 1.5rem;"></div>
  </section>


</main>

{% endblock %}

{% block scripts %}
<script type="module">
  import PhotoSwipeLightbox from "https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.js";

  const lightbox = new PhotoSwipeLightbox({
    gallery: "#photoswipe-gallery",
    children: "a",
    pswpModule: () =>
      import("https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js"),
  });
  lightbox.init();
</script>
<!-- Leaflet CSS y JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var lat = {{ latitude|stringformat:"f"|default:'null' }};
    var lng = {{ longitude|stringformat:"f"|default:'null' }};
    if (lat !== null && lng !== null) {
      var map = L.map('reserve-map').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href=\"https://www.openstreetmap.org/\">OpenStreetMap</a>'
      }).addTo(map);
      L.marker([lat, lng]).addTo(map)
        .bindPopup('{{ reserve.name }}')
        .openPopup();
    }
  });
</script>
{% endblock %}
